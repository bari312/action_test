name: CI with LocalStack

on: [push, pull_request]

jobs:
  localstack_test:
    # 実行環境を指定
    runs-on: ubuntu-latest
    
    # LocalStackコンテナをサービスとして定義
    services:
      localstack:
        # LocalStackのDockerイメージ
        image: localstack/localstack:latest
        
        # LocalStackコンテナ内のポート4566をホストに公開
        ports:
          - "4566:4566"
        
        # LocalStackの設定（ここではS3サービスのみを有効化）
        env:
          SERVICES: s3 
          DEFAULT_REGION: us-east-1
          AWS_ACCESS_KEY_ID: test
          AWS_SECRET_ACCESS_KEY: test
          AWS_ENDPOINT_URL: http://localstack:4566 # サービス名でアクセス
          
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # awslocal CLIのインストール（LocalStackへのアクセス用）
      - name: Install awslocal CLI
        run: pip install awscli-local

      # LocalStackの準備ができるまで待機（環境によっては必要）
      - name: Wait for LocalStack to be ready
        # LocalStackのエンドポイントのヘルスチェックを待つ
        run: |
          awslocal s3 ls --endpoint-url=http://localstack:4566
          # 成功するまでリトライするロジックを追加しても良い
      
      # LocalStack上でS3操作を実行
      - name: Create S3 bucket
        run: |
          BUCKET_NAME="my-test-bucket-$(date +%s)"
          # awslocalを使ってLocalStackのS3エンドポイントを指定してバケットを作成
          awslocal s3 mb s3://$BUCKET_NAME --endpoint-url=http://localstack:4566
          echo "Created bucket: $BUCKET_NAME"
          
