name: CI with LocalStack

on: [push, pull_request]

jobs:
  localstack_test:
    # å®Ÿè¡Œç’°å¢ƒã‚’æŒ‡å®š
    runs-on: ubuntu-latest
    
    # LocalStackã‚³ãƒ³ãƒ†ãƒŠã‚’ã‚µãƒ¼ãƒ“ã‚¹ã¨ã—ã¦å®šç¾©
    services:
      localstack:
        # LocalStackã®Dockerã‚¤ãƒ¡ãƒ¼ã‚¸
        image: localstack/localstack:latest
        
        # LocalStackã‚³ãƒ³ãƒ†ãƒŠå†…ã®ãƒãƒ¼ãƒˆ4566ã‚’ãƒ›ã‚¹ãƒˆã«å…¬é–‹
        ports:
          - "4566:4566"
        
        # LocalStackã®è¨­å®šï¼ˆã“ã“ã§ã¯S3ã‚µãƒ¼ãƒ“ã‚¹ã®ã¿ã‚’æœ‰åŠ¹åŒ–ï¼‰
        env:
          SERVICES: s3 
          DEFAULT_REGION: us-east-1
          AWS_ACCESS_KEY_ID: test
          AWS_SECRET_ACCESS_KEY: test
          AWS_ENDPOINT_URL: http://localstack:4566 # ã‚µãƒ¼ãƒ“ã‚¹åã§ã‚¢ã‚¯ã‚»ã‚¹
          
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # awslocal CLIã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆLocalStackã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ç”¨ï¼‰
      - name: Install awslocal CLI
        run: pip install awscli-local

      # LocalStackã®æº–å‚™ãŒã§ãã‚‹ã¾ã§å¾…æ©Ÿï¼ˆç’°å¢ƒã«ã‚ˆã£ã¦ã¯å¿…è¦ï¼‰
      # ğŸš¨ ä¿®æ­£å¾Œã®ã‚¹ãƒ†ãƒƒãƒ— ğŸš¨
      - name: Wait for LocalStack to be ready with retry
        timeout-minutes: 5 # ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’è¨­å®š
        run: |
          MAX_RETRIES=10
          for i in $(seq 1 $MAX_RETRIES); do
            echo "Attempt $i/$MAX_RETRIES: Checking LocalStack readiness..."
            # awslocalã®å®Ÿè¡Œçµæœï¼ˆçµ‚äº†ã‚³ãƒ¼ãƒ‰ï¼‰ã‚’ãƒã‚§ãƒƒã‚¯
            awslocal s3 ls --endpoint-url=http://localstack:4566 2>/dev/null
            
            if [ $? -eq 0 ]; then
              echo "âœ… LocalStack is ready."
              exit 0
            fi
            
            if [ $i -lt $MAX_RETRIES ]; then
              echo "Waiting 5 seconds before next retry..."
              sleep 5
            fi
          done
          
          echo "âŒ LocalStack failed to start after $MAX_RETRIES attempts."
          exit 1 # ãƒªãƒˆãƒ©ã‚¤å¤±æ•—ã§ã‚¸ãƒ§ãƒ–ã‚’å¤±æ•—ã•ã›ã‚‹
        shell: bash
      
      # LocalStackä¸Šã§S3æ“ä½œã‚’å®Ÿè¡Œ
      - name: Create S3 bucket
        run: |
          BUCKET_NAME="my-test-bucket-$(date +%s)"
          # awslocalã‚’ä½¿ã£ã¦LocalStackã®S3ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’æŒ‡å®šã—ã¦ãƒã‚±ãƒƒãƒˆã‚’ä½œæˆ
          awslocal s3 mb s3://$BUCKET_NAME --endpoint-url=http://localstack:4566
          echo "Created bucket: $BUCKET_NAME"
          
